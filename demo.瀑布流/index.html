<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<title></title>
		<style type="text/css">
				#ul1{width: 1080px;margin: 50px auto;list-style: none;}
				li{width: 247px;float: left;margin-right: 10px;}
				li div{margin-bottom: 10px;padding: 10px;border: 1px solid black;}
				li img{width: 225px;}
				p{margin: 0px;}
		</style>
		<script type="text/javascript">
			function ajax(method, url, data, success) {
					var xhr = null;
					try {
						xhr = new XMLHttpRequest();
					} catch (e) {
						xhr = new ActiveXObject('Microsoft.XMLHTTP');
					}
					
					if (method == 'get' && data) {
						url += '?' + data;
					}
					
					xhr.open(method,url,true);
					if (method == 'get') {
						xhr.send();
					} else {
						xhr.setRequestHeader('content-type', 'application/x-www-form-urlencoded');
						xhr.send(data);
					}
					
					xhr.onreadystatechange = function() {
						
						if ( xhr.readyState == 4 ) {
							if ( xhr.status == 200 ) {
								success && success(xhr.responseText);
							} else {
								alert('出错了,Err：' + xhr.status);
							}
						}
						
					}
				}
		
			window.onload=function  () {
				
				var oul=document.getElementById('ul1')
				var oli=document.getElementsByTagName('li')
				var olen=oli.length
				var ipage=1
				var b=true
				function getlist () {
					ajax('get','getPics.php','cpage='+ipage,function(date){	
					var date=JSON.parse(date)
					if (!date.length) {
							return
						}
					console.log(date)
			        for (var i=0;i<date.length;i++) {
			       		var _index=getshort()
			        		var odiv=document.createElement('div')
			        		var oimg=document.createElement('img')
			        		oimg.src=date[i].preview
			        		oimg.style.height=date[i].height*(225/date[i].width)+'px'
			        		odiv.appendChild(oimg)
			        		var op=document.createElement('p')
			        		op.innerHTML=date[i].title
			        		odiv.appendChild(op)
			        		oli[_index].appendChild(odiv)
			        }
			        	 b=true	
				})       
			}
				getlist()
				function getshort () {
				var index=0
				var oh=oli[index].offsetHeight;
				for (i=1;i<olen;i++) {
					if (oli[i].offsetHeight<oh) {
						index=i
						oh=oli[i].offsetHeight
					}
				}
				return index
			   }
				function gettop (obj) {
					var itop=0
					while(obj){
						itop+=obj.offsetTop
						obj=obj.offsetParent
					}
					return itop
				}
			window.onscroll=function  () {
				var _index=getshort()
				var scrollTop=document.documentElement.scrollTop||document.body.scrollTop;
				if (gettop(oli[_index])+oli[_index].offsetHeight<document.documentElement.clientHeight+scrollTop) {
					if (b) {
						b=false
						ipage++
						getlist()	
					}
				}
			}
}
			
		</script>
		
	</head>
	<body>
		<ul id="ul1">
			<li>
				
			</li>
			<li>
				
			</li>
			<li>
				
			</li>
			<li>
				
			</li>	
		</ul>
	</body>
</html>
